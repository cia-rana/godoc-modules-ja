# Go Modules Reference
## はじめに
モジュールはGoがパッケージを管理する仕組みです。

このドキュメントはGoのモジュールに関する詳細なリファレンスマニュアルです。Goのプロジェクトを作り始める際は、[How to Write Go Code](https://golang.org/doc/code)をご覧ください。モジュールを使用したり、モジュールにプロジェクトをマイグレートしたり、その他トッピクスについては、[Using Go Modules](https://blog.golang.org/using-go-modules)から始まる一連のブログ記事をご覧ください。

## モジュール、パッケージ、バージョン

**モジュール**は一緒にリリース、バージョンコントロール、配布されるパッケージの集合です。モジュールはバージョンコントロールリポジトリから直接ダウンロードしたり、モジュールのプロキシサーバーからダウンロードできます。

モジュールは、[`go.mod`ファイル](https://golang.org/ref/mod#go-mod-file)で宣言された[モジュールパス](https://golang.org/ref/mod#glos-module-path)と、そのモジュールの依存関係に関する情報によって識別されます。**モジュールのルートディレクトリ**は`go.mod`ファイルを含むディレクトリです。**メインモジュール**は`go`コマンドが呼ばれるディレクトリを含むディレクトリです。

モジュール内のそれぞれの**パッケージ**は、同じディレクトリ内にあり一緒にコンパイルされるソースファイルの集合です。**パッケージパス**は、モジュールパスとパッケージを含むサブディレクトリ（モジュールルートからの相対パスになります）です。例えば、モジュール`"golang.org/x/net"`はディレクトリ`"html"`中のパッケージを含みます。そのパッケージパスは`"golang.org/x/net/html"`になります。

### モジュールパス

**モジュールパス**はモジュールの正式名称で、モジュールの[go.modファイル](https://golang.org/ref/mod#glos-go-mod-file)内で[モジュールディレクティブ](https://golang.org/ref/mod#go-mod-file-module)を使って宣言されます。モジュールのパスは、そのモジュール内に含まれるパッケージのプレフィクスです。

モジュールパスは、そのモジュールが何をするのか、そしてどこにあるのかを説明しなければなりません。通常、モジュールパスは、リポジトリルートパス、リポジトリ内のディレクトリ（通常は空）、メジャーバージョンのサフィックス（メジャーバージョン2以上の場合のみ）で構成されています。

- **リポジトリルートパス**は、モジュールパスのうち、そのモジュールが開発されているバージョンコントロールリポジトリのルートディレクトリに対応しています。ほとんどのモジュールは、そのリポジトリのルートディレクトリで定義されているため、通常そのパスは全体のパスとなります。例えば、`golang.org/x/net`は同名のモジュールに対するリポジトリルートパスです。`go`コマンドがモジュールパスを元にしてHTTPリクエストでリポジトリを検索する方法については、[Finding a repository for a module path](https://golang.org/ref/mod#vcs-find)をご覧ください。
- モジュールがリポジトリのルートディレクトリ定義されていない場合、**モジュールサブディレクトリ**はモジュールパスの中のディレクトリ名の部分にあたり、メジャーバージョンのサフィックスは含みません。これはセマンティックバージョンタグのプレフィクスとしても機能します。例えば、モジュール`golang.org/x/tools/gopls`は`golang.org/x/tools`をルートとするリポジトリのサブディレクトリ`gopls`にあるので、モジュールサブディレクトリ`gopls`を持っています。[Mapping versions to commits](https://golang.org/ref/mod#vcs-version)や[Module directories within a repository](https://golang.org/ref/mod#vcs-dir)をご覧ください。
- モジュールがメジャーバージョン2以上でリリースされている場合、モジュールパスは`/v2`のようなメジャーバージョンのサフィックスで終わらなければなりません。これはサブディレクトリ名の一部であってもなくてもどちらでも構いません。例えば、`golang.org/x/repo/sub/v2`というパスのモジュールは、リポジトリ`golang.org/x/repo`のサブディレクトリ`/sub`または`/sub/v2`にあります。

あるモジュールが他のモジュールに依存している可能性がある場合、`go`コマンドがそのモジュールを見つけてダウンロードできるように、以上のルールに従う必要があります。また、モジュールパスで使用できる文字には、いくつかの[制限](https://golang.org/ref/mod#go-mod-file-ident)があります。

### バージョン

**バージョン**は、モジュールの不変的なスナップショットを識別し、[release](https://golang.org/ref/mod#glos-release-version)または[pre-release](https://golang.org/ref/mod#glos-pre-release-version)のいずれかになります。各バージョンは`v`で始まり、その後にセマンティックバージョンが続きます。バージョンの形式や解釈、比較についての詳細は[Semantic Versioning 2.0.0](https://semver.org/spec/v2.0.0.html)をご覧ください。

要約すると、セマンティックバージョンは、ドットで区切られた3つの非負整数（左からメジャーバージョン、マイナーバージョン、パッチバージョン）で構成されています。パッチバージョンの後には、オプションでハイフンで始まるプレリリース文字列をつけることができます。プレリリース文字列やパッチバージョンの後には、プラスで始まるビルドメタデータ文字列をつけることができます。例えば、`v0.0.0`、`v1.12.134`、`v8.0.5-pre`、`v2.0.9+meta`は全て有効なバージョンです。

バージョンの各パートは、そのバージョンが安定しているかどうかや、以前のバージョンと互換性があるかどうかを示しています。

- パッケージが削除されるなど、モジュールのパブリックインターフェースやドキュメント化された機能に後方互換性のない変更が加えられた後は、[major version](https://golang.org/ref/mod#glos-major-version)をインクリメントし、マイナーバージョンとパッチバージョンをゼロに設定しなければなりません。
- 新しい機能が追加されるなど、後方互換性のある変更を行った後は、[minor version](https://golang.org/ref/mod#glos-minor-version)をインクリメントし、パッチバージョンをゼロに設定しなければなりません。
- バグフィックスや最適化など、モジュールのパブリックインターフェースに影響を与えない変更を行った後は、[patch version](https://golang.org/ref/mod#glos-patch-version)をインクリメントしなければなりません。
- プレリリースのサフィックスは、そのバージョンが[pre-release](https://golang.org/ref/mod#glos-pre-release-version)であることを示します。プレリリースバージョンは対応するリリースバージョンの前にソートされます。例えば、`v1.2.3-pre`は`v1.2.3`より前になります。
- バージョンを比較する際は、ビルドメタデータのサフィックスは無視されます。ビルドメタデータつきのタグは、バージョンコントロールリポジトリでは無視されますが、`go.mod`ファイルで明示されたバージョンにはビルドメタデータが保存されます。サフィックス`+incompatible`は、モジュールのバージョンがメジャーバージョン2以上に移行するする前にリリースされたバージョンであることを示します（[Compatibility with non-module repositories](https://golang.org/ref/mod#non-module-compat)をご覧ください）。

メジャーバージョンが0であったり、プレリリースのサフィックスがついていたりすると、不安定なバージョンと思われてしまいます。不安定なバージョンは互換性を満たさないかもしれません。例えば、`v0.2.0`は`v0.1.0`と互換性がないかもしれませんし、さらに言うと`v1.5.0-beta`は`v1.5.0`と互換性がないかもしれません。

Goはバージョンコントロールシステムのモジュールにアクセスする際に、このルールに従わないタグ、ブランチ、リビジョンを使用することがあります。しかし、メインモジュール内では、`go`コマンドがこのルールに従わないリビジョン名を自動的に正規のバージョンに変換します。`go`コマンドは、このプロセス中にビルドメタデータのサフィックス（`+incompatible`を除く）も削除します。この結果として、バージョンコントロールシステムからリビジョン識別子（Gitコミットハッシュなど）とタイムスタンプをエンコードして、リリース前のバージョンである[pseudo-version](https://golang.org/ref/mod#glos-pseudo-version)を生成することがあります。例えば、コマンド`go get -d golang.org/x/net@daa7c041`はコミットハッシュ`daa7c041`を疑似バージョン`v0.0.0-20191109021931-daa7c04131f5`に変換します。正規のバージョンはメインモジュールの外側で必要とされ、`go.mod`ファイルに`master`のような非正規なバージョンがある場合、エラーを出力します。

### 疑似バージョン

**疑似バージョン**は、バージョンコントロールリポジトリの特定のリビジョンに関する情報をエンコードした、特別な形式の[pre-release version](https://golang.org/ref/mod#glos-pre-release-version)です。例えば、`v0.0.0-20191109021931-daa7c04131f5`は疑似バージョンです。

疑似バージョンは、[semantic version tags](https://golang.org/ref/mod#glos-semantic-version-tag)がないリビジョンを参照します。例えば、開発ブランチなどバージョンタグを作成する前にコミットをテストするために使用されます。

各疑似バージョンは3つのパートから成り立っています。

- ベースバージョンプレフィックス（`vX.0.0`または`vX.Y.Z-0`）。リビジョンの前にあるセマンティックバージョンタグから派生したものか、そのようなタグがない場合は`vX.0.0`です。
- タイムスタンプ（`yyyymmddhhmmss`）。リビジョンが作成されたUTC時間です。Gitの場合は、AuthorDateではなくCommitDateが使われます。
- リビジョン識別子（`abcdefabcdef`）。コミットハッシュのプレフィクス12文字で、Subversionではゼロパディングされたリビジョン番号です。

各疑似バージョンは、ベースバージョンに応じて3つの形式のうちの1つが採用されます。これらの形式は、疑似バージョンがそのベースバージョン以上で、かつ次のタグつきバージョン以下であることを保証します。

- `vX.0.0-yyyymmddhhmmss-abcdefabcdef`は、既知のベースバージョンがない場合に使用されます。ほかのバージョンと同様に、メジャーバージョン`X`はモジュールの[major version suffix](https://golang.org/ref/mod#glos-major-version-suffix)と一致しなければなりません。
- `vX.Y.Z-pre.0.yyyymmddhhmmss-abcdefabcdef`は、ベースバージョンが`vX.Y.Z-pre`のようにプレリリースバージョンの場合に使用されます。
- `vX.Y.(Z+1)-0.yyyymmddhhmmss-abcdefabcdef`は、ベースバージョンが`vX.Y.Z`のようにリリースバージョンの場合に使用されます。例えば、ベースバージョンが`v1.2.3`の場合、疑似バージョンは`v1.2.4-0.20191109021931-daa7c04131f5`のようになります。

複数の疑似バージョンが異なるベースバージョンを使用して同じコミットを参照することがあります。これは疑似バージョンが書かれた後にそれより前のバージョンがタグづけされた場合に自然に起こることです。

これらの形式は、疑似バージョンに2つのメリットをもたらします。

- ベースバージョンが分かっている疑似バージョンは、そのベースバージョン以上で、かつ後方のプレリリースバージョン以下になります。
- ベースバージョンのプレフィクスが同じである疑似バージョンは、時系列順にソートされます。

`go`コマンドは、モジュール作者が疑似バージョンと他のバージョンとの比較を制御できることと、疑似バージョンがモジュールのコミット履歴に実際に含まれているリビジョンを参照していることを保証するために、いくつかのチェックを行います。

- ベースバージョンが明示されている場合、対応するセマンティックバージョンタグが存在しなければなりません。そのタグは疑似バージョンに記述されたリビジョンの祖先です。これにより、開発者が`v1.999.999-99999999999999-daa7c04131f5`のようにタグづけされたすべてのバージョン以上の疑似バージョンを使って[minimal version selection](https://golang.org/ref/mod#glos-minimal-version-selection)を回避することを防ぎます。
- タイムスタンプはリビジョンのタイムスタンプと一致しなければなりません。これにより、攻撃者が[module proxies](https://golang.org/ref/mod#glos-module-proxy)に無制限に同一の疑似バージョンを作ることを防ぎます。また、モジュールの利用者がバージョンの相対的な順序を変更することも防ぎます。
- リビジョンはモジュールリポジトリのブランチやタグのいづれかの祖先でなければなりません。これにより、攻撃者が未承認の変更やプルリクエストを参照することを防ぎます。

疑似バージョンは手動で入力する必要はありません。多くのコマンドは、コミットハッシュやブランチ名を受け取ると、それを自動的に疑似バージョン（可能であればタグつきバージョン）に変換します。例えば以下のようになります。

```sh
go get -d example.com/mod@master
go list -m -json example.com/mod@abcd1234
```

### メジャーバージョンのサフィックス



### パッケージをモジュールとして扱う



## `go.mod`ファイル
